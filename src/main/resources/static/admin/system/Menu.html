<!DOCTYPE html>
<html>

<head>
<meta charset="utf-8">
<title>任务订单后台管理列表</title>
<link rel="stylesheet" href="../lib/layui/css/layui.css"
	media="all">
<link rel="stylesheet" href="../css/font.css">
<script src="../lib/layui/layui.js"></script>
<script src="../lib/module/common.js"></script>

</head>

<body>
	<table class="layui-table layui-container"
		lay-data="{url:'/api/getSystemModuleByPid', page:{limit:20}, id:'item',toolbar:'#toolbarDemo'}"
		lay-filter="test" id="TablePage">
		<thead>
			<tr>
				<th lay-data="{type:'checkbox'}"></th>
				<th lay-data="{field:'modId',sort: true,align:'center'}">菜单编号</th>
				<th lay-data="{field:'level',align:'center'}">菜单等级</th>
				<!--  <th lay-data="{field:'module',align:'center'}">菜单类型</th>-->
				<th lay-data="{field:'title',align:'center',edit: 'text'}">菜单名称</th>
				<th lay-data="{field:'visible',align:'center',templet:'#disPlayMenu'}">是否显示</th>
				<th lay-data="{field:'parentId',align:'center'}">上级菜单</th>
				<th lay-data="{field:'orderby',sort: true,align:'center',edit: 'text'}">排序(越小显示越靠前)</th>
				<th
					lay-data="{field:'icon',templet:'#icon',align:'center'}">菜单图标</th>
					<th lay-data="{field:'url',edit: 'text',align:'center'}">菜单路径</th>
				<th
					lay-data="{fixed: 'right', width:200, align:'center', toolbar: '#barDemo',align:'center'}">操作</th>
			</tr>
		</thead>
	</table>


	<!--创建子菜单数据表窗口-->
	<div id="SecondWindow" style="display: none">
		<table class="layui-table layui-container"
			lay-data="{url:'', page:true, id:'SecondWindow',toolbar:'#toolbarDemo'}"
			lay-filter="SecondWindow">
			<thead>
				<tr>
					<th lay-data="{type:'checkbox'}"></th>
				<th lay-data="{field:'modId',sort: true,align:'center'}">菜单编号</th>
				<th lay-data="{field:'level',sort: true,align:'center'}">菜单等级</th>
				<th lay-data="{field:'title', sort: true,align:'center',edit: 'text'}">菜单名称</th>
				<th lay-data="{field:'visible',align:'center',templet:'#disPlayMenu'}">是否显示</th>
				<th lay-data="{field:'parentId', sort: true,align:'center'}">上级菜单</th>
				<th lay-data="{field:'orderby',align:'center',edit: 'text'}">排序</th>
				<th
					lay-data="{field:'icon', sort: true,templet:'#icon',align:'center'}">菜单图标</th>
					<th lay-data="{field:'url',edit: 'text',align:'center'}">菜单路径</th>
					<th
						lay-data="{fixed: 'right', width:200, align:'center', toolbar: '#secondList'}">操作</th>
				</tr>
			</thead>
		</table>
	</div>

	<script>
    //主页面菜单数据表的事件监听
    layui.use('table', function () {

      var table = layui.table;
      var $ = layui.jquery;
      var form=layui.form;
      //头工具栏事件
      table.on('toolbar', function (obj) {
        var checkStatus = table.checkStatus(obj.config.id);
        switch (obj.event) {
          case 'add':
            var data = checkStatus.data;

            layui.use('layer', function () {
              layer = layui.layer; //独立版的layer无需执行这一句
              layer.open({
                type: 1 //此处以iframe举例
                  ,
                title: '添加任务',
                area: ['500px'],
                shade: 0,
                maxmin: true,
                content: $('#formAdd'),
                zIndex:'1000' //重点      
              });
            });
            break;
          case 'delete':
            var data = checkStatus.data;
            if (data.length > 0) {
              layer.confirm('确定删除选中行么?', function (index) {
                var idList = []
                data.forEach(element => {
                  idList = idList.concat(element.modId);
                });
                var idListStr = JSON.stringify(idList);
                layer.close(index);
                //向服务端发送删除指令
                var loading = layer.load();
                $.ajax({
                    type: 'post',
                    url: '/api/deleteMenu',
                    data: {
                      ids: idListStr
                    },
                    success: function (obj) {
                  	  console.log(obj);
                      if (obj.code != 0) {
                        layer.msg(obj.msg)
                      } else {
                        layer.msg("删除菜单"+obj.msg)
                      }
                    },
                    error: function (obj) {
                      layer.msg("请求异常");
                    },
                    complete: function () {
                    	layer.close(loading)
                        tableRefresh('item')
                        tableRefresh('SecondWindow')
                    }
                  });
                  return false;
              });
            } else {
              layer.msg("最少选中一行!");
            }
            break;
          case 'Refresh':
            tableRefresh('item')
            tableRefresh('SecondWindow')
            break;
        };
      });

      //监听数据主表工具条
      table.on('tool', function (obj) { //注：tool是工具条事件名，test是table原始容器的属性 lay-filter="对应的值"
        var data = obj.data; //获得当前行数据
        var layEvent = obj.event; //获得 lay-event 对应的值（也可以是表头的 event 参数对应的值）
        var tr = obj.tr; //获得当前行 tr 的DOM对象

        if (layEvent === 'detail') { //查看
          if(data.level!=="三级菜单"){
            var id = data.modId
            var nav=data.title
          table.reload('SecondWindow',{
            url:'/api/getSystemModuleByPid',
            where:{
            	pid:id
            },
          })
          layui.use('layer', function () {
              layer = layui.layer; //独立版的layer无需执行这一句
              layer.open({
                type: 1,//此处以iframe举例
                title: '子菜单列表',
                area: ['1100px','500px'],
                shade: 0,
                maxmin: true,
                content: $('#SecondWindow'),
                zIndex: '1000' //重点      
              });
            });
          }else{
            layer.msg("终极菜单没有子菜单!")
          }
        } else if (layEvent === 'del') { //删除
          layer.confirm('真的删除行么', function (index) {
            var id = [];
            id = id.concat(""+data.modId);
            obj.del(); //删除对应行（tr）的DOM结构，并更新缓存
            layer.close(index);
            idList = JSON.stringify(id)
            //向服务端发送删除指令
            var loading = layer.load();
            
            $.ajax({
              type: 'post',
              url: '/api/deleteMenu',
              data: {
                ids: idList
              },
              success: function (obj) {
            	  console.log(obj);
                if (obj.code != 0) {
                  layer.msg(obj.msg)
                } else {
                  layer.msg("删除菜单"+obj.msg)
                }
              },
              error: function (obj) {
                layer.msg("请求异常");
              },
              complete: function () {
            	  layer.close(loading)
              }
            });
            return false;
          });
        } else if (layEvent === 'edit') { //编辑
          //do something

          //同步更新缓存对应的值
          obj.update({
            username: '123',
            title: 'xxx'
          });
        }
      });
      

      //监听单元格编辑
      table.on('edit', function (obj) {
        var value = obj.value //得到修改后的值
          ,
          data = obj.data //得到所在行所有键值
          ,
          field = obj.field; //得到字段
        var strTask = '{"modId":' + data.modId + ',"' + field + '":"' + value + '"}';
        var upTask = JSON.parse(strTask);
        console.log(upTask);
        var loading=layer.load();
        
        $.ajax({
          type: 'post',
          url: '/api/updataMenu',
          data: upTask,
          success: function (obj) {
        	  console.log(obj);
            if (obj.code != 1) {
              layer.msg("修改"+obj.jsonData)
            } else {
            	parent.layer.msg("修改"+obj.msg)
            }
          },
          error: function (obj) {
        	  parent.layer.msg("请求异常");
          },
          complete: function () {
        	  layer.close(loading)
        	  tableRefresh("item");
          }
        });
        return false;
      });
      
    //监听switch开关
      form.on('checkbox(disPlayMenu)', function (obj) {
        var modId = obj.elem.attributes.modId.value;
        var visible = obj.elem.value;
        if (visible=="true") {
        	visible=false;
        } else {
        	visible =true;

        }
        console.log(visible)
        var loading = layer.load();
          layer.close(loading)
      $.ajax({
          type: 'post',
          url: '/api/updataMenu',
          data: {
        	  modId: modId,
            visible: visible
          },
          success: function (obj) {
        	  console.log(obj);
            if (obj.code != 0) {
              layer.msg(obj.msg)
            } else {
            	parent.layer.msg("修改"+obj.msg)
            }
          },
          error: function (obj) {
        	  parent.layer.msg("请求异常");
          },
          complete: function () {
        	  layer.close(loading)
              tableRefresh('item')
              tableRefresh('SecondWindow')
          }
          
        });
        return false;
      });

    });
    //局部刷新数据表
    function tableRefresh(obj) {
      var table = layui.table;
      table.refresh(obj);
    }
    
    </script>
    
	<!--自定义表单图标-->
	<script type="text/html" id="icon">
       <i class="layui-icon">{{d.icon}}</i>
    </script>
    
     <!-- checked 选中按钮  -->
  <script type="text/html" id="disPlayMenu">
    <input type="checkbox" modId="{{d.modId}}" name="visible" value="{{d.visible}}" title="显示"
      lay-filter="disPlayMenu" {{d.visible=="true"?'checked':'0' }}>
  </script>

	</script>
	<!--工具条事件菜单主表-->
	<script type="text/html" id="barDemo">
     <button  lay-event="detail" {{d.level=="三级菜单"?'class="layui-btn layui-btn-xs layui-btn-disabled"' : 'class="layui-btn layui-btn-xs"'}}><i class="layui-icon">&#xe615;</i>下级菜单</button>
    <!-- <a class="layui-btn layui-btn-warm layui-btn-xs" lay-event="add">添加子菜单</a>-->

  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
  </script>

	</script>
	<!--工具条事件菜单弹窗表-->
	<script type="text/html" id="secondList">
     <button  lay-event="detail" {{d.level=="三级菜单"?'class="layui-btn layui-btn-xs layui-btn-disabled"' : 'class="layui-btn layui-btn-xs"'}}><i class="layui-icon">&#xe615;</i>下级菜单</button>
     <!--<a  lay-event="add" {{d.level=="三级菜单"?'class="layui-btn layui-btn-xs layui-btn-disabled"' : 'class="layui-btn layui-btn-warm layui-btn-xs"'}}>添加子菜单</a>-->

  <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
  </script>

	<!--工具条事件 task快递信息子表-->
	<script type="text/html" id="toobarExpress">
    <!-- <a class="layui-btn layui-btn-primary layui-btn-xs" lay-event="detail">查看</a> -->
    <a class="layui-btn  layui-btn-xs" lay-event="edit">编辑</a>
    <a class="layui-btn layui-btn-danger layui-btn-xs" lay-event="del">删除</a>
  </script>
	<!--头部工具条事件-->
	<script type="text/html" id="toolbarDemo">
    <div class="layui-btn-container">
      <button type="button" class="layui-btn" lay-event="add"><i class="layui-icon">&#xe608;</i> 添加</button>
      <button type="button" class="layui-btn layui-btn-danger" lay-event="delete"><i
          class="layui-icon">&#xe640;</i>删除选中</button>
      <button class="layui-btn layui-btn-warm" lay-event="Refresh"><i class="layui-icon">&#xe9aa;</i>刷新表格当前页</button>
    </div>
  </script>

	<!-- <script>
layui.use('laypage', function(){
  var laypage = layui.laypage;
  
  //执行一个laypage实例
  laypage.render({
     title: '任务表'
    ,page: true //开启分页
    ,toolbar: 'default' //开启工具栏，此处显示默认图标，可以自定义模板，详见文档
    ,totalRow: true //开启合计行
    ,elem: document.getElementById('TablePage') //注意，这里的 test1 是 ID，不用加 # 号
    ,count:50//数据总数，从服务端得到
  });
});
</script> -->
	<form class="layui-form" action="" id="formAdd"
		style="display: none; padding: 50px 75px 50px 50px;">
		

		<div class="layui-form-item">
			<label class="layui-form-label">菜单名称:</label>
			<div class="layui-input-block">
				<input type="text" name="title" required="" lay-verify="required"
					placeholder="请输入菜单名称" autocomplete="off"
					class="layui-input layui-form-danger">
			</div>
		</div>
		
		
		<div class="layui-form-item">
			<label class="layui-form-label">菜单类型:</label>
			<div class="layui-input-block layui-icon">
			<input type="hidden" id="selectModule" name="module" class="layui-input">
				<select name="icon" lay-verify="required" lay-filter="selectModule">
					<option value=""></option>
					<option value="0"><i>top</i></option>
					<option value="1"><i>menu</i></option>
					<option value="2"><i>module</i></option>
				</select>
			</div>
		</div>
		

		<div class="layui-form-item">
			<label class="layui-form-label">是否显示:</label>
			<div class="layui-input-block">
				<input type="checkbox" lay-skin="switch" name="visible" title="显示"
					value="1" checked>
			</div>
		</div>

		<!-- 普通下拉选择
		<div class="layui-form-item">
			<label class="layui-form-label">上级菜单:</label>
			<div class="layui-input-block chooseNav">
				<select name="parentId" lay-filter="choosePnav" id="selectPNav"
					lay-verify="required" lay-search>
				</select>
			</div>
		</div> -->
		
		
       <div class="layui-form-item">
           <label for="" class="layui-form-label">上级菜单:</label>
           <div class="layui-input-block">
               <input type="number" name="parentId" id="selectPNav" lay-filter="tree" class="layui-input">
           </div>
       </div>
  	
		
	

		<div class="layui-form-item">
			<label class="layui-form-label">请选择图标:</label>
			<div class="layui-input-block layui-icon">
			<input type="hidden" id="selectIcon" name="icon" class="layui-input">
				<select name="icon" lay-verify="required" lay-filter="selectIcon">
					<option value=""></option>
					<option value="&#xe665;"><i>&#xe665;</i></option>
					<option value="&#xe716;"><i>&#xe716;</i></option>
					<option value="&#xe770;"><i>&#xe770;</i></option>
				</select>
			</div>
		</div>
		
		<div class="layui-form-item">
			<label class="layui-form-label">排序:</label>
			<div class="layui-input-block">
				<input type="number" name="orderby" min="0" max="50" required=""
					lay-verify="required" placeholder="越小排序越靠前" autocomplete="off"
					class="layui-input layui-form-danger">
			</div>
		</div>
		
		<div class="layui-form-item">
			<label class="layui-form-label">菜单路径:</label>
			<div class="layui-input-block">
				<input type="text" name="url" required="" lay-verify="required"
					placeholder="请输入菜单路径" autocomplete="off"
					class="layui-input layui-form-danger">
			</div>
		</div>

		<div class="layui-form-item">
			<div class="layui-input-block">
				<button class="layui-btn" lay-submit="" lay-filter="formDemo">立即提交</button>
				<button type="reset" class="layui-btn layui-btn-primary">重置</button>
			</div>
		</div>
	</form>


	<script>
    //监听添加窗口的表单提交按钮
    layui.use('form', function () {
      var form = layui.form;
      var $ = layui.jquery;
      //监听提交
      form.on('submit(formDemo)', function (data) {
    	  console.log(data.field);
    	  var loading = layer.load();
        
       $.ajax({
          type: 'post',
          url: '/api/addSystemModule',
          data: data.field,
          success: function (obj) {
        	  console.log(obj);
            if (obj.code != 0) {
            	parent.layer.msg(obj.msg)
            } else {
            	parent.layer.msg("添加失败!"+obj.msg)
            }
          },
          error: function (obj) {
        	  parent.layer.msg("请求异常");
          },
          complete: function () {
        	  layer.close(loading)
        	  tableRefresh('item')
              tableRefresh('SecondWindow')
          }
        });
        return false;
        
      })
      //图标选择下拉事件监听
      form.on('select(selectIcon)',function(data){
    	  var selectIcon=document.getElementById("selectIcon");
    	  selectIcon.setAttribute("value",data.value);
      })
      
      //菜单类型选择下拉事件监听
      form.on('select(selectModule)',function(data){
    	  var selectIcon=document.getElementById("selectModule");
    	  selectIcon.setAttribute("value",data.value);
      })
    //点击事件绑定
    /*  	$(document).on('click','.chooseNav',function(){
	        	var role = document.getElementById("selectPNav");
      		if (role.children.length<=0) {
      			 $.ajax({
         	          type: 'post',
         	          url: '/api/getSystemModuleByPid',
         	          success: function (obj) {
         	      		var list=obj.data
         	      		for(var i=0;i<list.length;i++){
         	      			                            var option = document.createElement("option");    // 创建添加option属性
         	      			                            option.setAttribute("value",list[i].modId);                  // 给option的value添加值
         	      			                            option.innerText=list[i].title;             // 打印option对应的纯文本 （超级管理员、管理员）
         	      			                            role.appendChild(option);                          // 给select 添加option子标签
         	      			                  }
         	          },
         	          error: function (obj) {
         	            layer.msg("请求异常");
         	          },
         	          complete: function () {
         	        	  form.render('select');
         	          }
         	        });
      			 return false;
      		}
      	});*/
    });
  </script>



  <script>
  //下拉树事件选择上级导航栏
    layui.use(['treeSelect','form'], function () {
        var treeSelect= layui.treeSelect;

        treeSelect.render({
            // 选择器
            elem: '#selectPNav',
            // 数据
            data: '/api/getSelectTreeNo',
            // 异步加载方式：get/post，默认get
            type: 'get',
            // 占位符
            placeholder: '请选择',
            // 是否开启搜索功能：true/false，默认false
            search: true,
            // 点击回调
            click: function(d){
                var selectPNav= document.getElementById("selectPNav");
                selectPNav.setAttribute('value',d.current.id)   
            },
            // 加载完成后的回调函数
            success: function (d) {
//                选中节点，根据id筛选
//                treeSelect.checkNode('tree', 3);

//                获取zTree对象，可以调用zTree方法
//                var treeObj = treeSelect.zTree('tree');
//                console.log(treeObj);

//                刷新树结构
//                treeSelect.refresh();
            }
        });      
    });
    </script>

   
   
</body>

</html>